# SystemYA Proxy

<a href="https://www.npmjs.com/package/sys-proxy">![Download](https://img.shields.io/npm/dw/sys-proxy?style=for-the-badge)</a>

## Quickstart:

```
git clone https://github.com/sysce/proxy ./sys-proxy

node ./sys-proxy/demo
```

## Installation:

```
npm i sys-proxy
```

### Demo:

See the [demo folder](demo/) for more usage examples

```
var nodehttp = require('sys-nodehttp'),
	rewriter = require('sys-proxy'),
	server = new nodehttp.server({
		port: 7080,
		static: path.join(__dirname, 'public'),
	}),
	rw = new rewriter({
		prefix: '/service',
		codec: rewriter.codec.xor,
		server: server,
		title: 'Service',
		// http_agent: ..,
		// https_agent: ..,
		// ruffle: ..,
		// adblock: ..,
	});

// [0000] server listening on http://localhost:7080/
```

## API:

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [index][1]
    -   [Parameters][2]
    -   [Properties][3]
    -   [url][4]
        -   [Parameters][5]
    -   [unurl][6]
        -   [Parameters][7]
    -   [js][8]
        -   [Parameters][9]
    -   [css][10]
        -   [Parameters][11]
    -   [manifest][12]
        -   [Parameters][13]
    -   [html][14]
        -   [Parameters][15]
    -   [html_attr][16]
        -   [Parameters][17]
    -   [plain][18]
        -   [Parameters][19]
    -   [decode_blob][20]
        -   [Parameters][21]
    -   [attr_type][22]
        -   [Parameters][23]
    -   [headers_decode][24]
        -   [Parameters][25]
    -   [headers_encode][26]
        -   [Parameters][27]
    -   [cookie_encode][28]
        -   [Parameters][29]
    -   [cookie_decode][30]
        -   [Parameters][31]
    -   [decode_params][32]
        -   [Parameters][33]
    -   [decompress][34]
        -   [Parameters][35]
    -   [valid_url][36]
        -   [Parameters][37]
    -   [str_conf][38]
    -   [globals][39]
        -   [Parameters][40]
    -   [html_serial][41]
        -   [Parameters][42]
    -   [wrap][43]
        -   [Parameters][44]
    -   [checksum][45]
        -   [Parameters][46]

## index

Rewriter

### Parameters

-   `config` **[Object][47]** 
    -   `config.adblock` **[Boolean][48]?** Determines if the adblock.txt file should be used for checking URLs
    -   `config.ruffle` **[Boolean][48]?** Determines if ruffle.rs should be used for flash content
    -   `config.ws` **[Boolean][48]?** Determines if websocket support should be added
    -   `config.codec` **[Object][47]?** The codec to be used (rewriter.codec.plain, base64, xor)
    -   `config.prefix` **[Boolean][48]?** The prefix to run the proxy on
    -   `config.interface` **[Boolean][48]?** The network interface to request from
    -   `config.timeout` **[Boolean][48]?** The maximum request timeout time
    -   `config.title` **[Boolean][48]?** The title of the pages visited
    -   `config.http_agent` **[Object][47]?** Agent to be used for http&#x3A; / ws: requests
    -   `config.https_agent` **[Object][47]?** Agent to be used for https&#x3A; / wss: requests
-   `server` **[Object][47]** nodehttp/express server to run the proxy on, only on the serverside this is required

### Properties

-   `mime` **[Object][47]** Contains mime data for categorizing mimes
-   `attr` **[Object][47]** Contains attribute data for categorizing attributes and tags
-   `attr_ent` **[Object][47]** Object.entries called on attr property
-   `regex` **[Object][47]** Contains regexes used throughout the rewriter
-   `config` **[Object][47]** Where the config argument is stored
-   `URL` **[Object][47]** class extending URL with the `fullpath` property

### url

Prefixes a URL and encodes it

#### Parameters

-   `value`  
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter
    -   `data.type` **[Object][47]?** The type of URL this is (eg js, css, html), helps the rewriter determine how to handle the response
    -   `data.ws` **[Object][47]?** If the URL is a WebSocket
-   `null-null` **([String][49] \| [URL][50] \| [Request][51])** URL value

Returns **[String][49]** Proxied URL

### unurl

Attempts to decode a URL previously ran throw the URL handler

#### Parameters

-   `value`  
-   `data`   (optional, default `{}`)
-   `null-null` **[String][49]** URL value

Returns **[String][49]** Normal URL

### js

Scopes JS and adds in filler objects

#### Parameters

-   `value` **[String][49]** JS code
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter

Returns **[String][49]** 

### css

Rewrites CSS urls and selectors

#### Parameters

-   `value` **[String][49]** CSS code
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter

Returns **[String][49]** 

### manifest

Rewrites manifest JSON data, needs the data object since the URL handler is called

#### Parameters

-   `value` **[String][49]** Manifest code
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter

Returns **[String][49]** 

### html

Parses and modifies HTML, needs the data object since the URL handler is called

#### Parameters

-   `value` **[String][49]** Manifest code
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.snippet` **[Boolean][48]?** If the HTML code is a snippet and if it shouldn't have the rewriter scripts added
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter

Returns **[String][49]** 

### html_attr

Validates and parses attributes, needs data since multiple handlers are called

#### Parameters

-   `node` **([Node][52] \| [Object][47])** Object containing at least getAttribute and setAttribute
-   `name` **[String][49]** Name of the attribute
-   `data` **[Object][47]** Standard object for all rewriter handlers
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter

### plain

Soon to add removing the servers IP, mainly for converting values to strings when handling

#### Parameters

-   `value` **([String][49] \| [Buffer][53])** Data to convert to a string
-   `data` **[Object][47]** Standard object for all rewriter handlers

### decode_blob

Decoding blobs

#### Parameters

-   `data`  
-   `Blob`  

Returns **[String][49]** 

### attr_type

Determines the attribute type using the `attr_ent` property

#### Parameters

-   `name` **[String][49]** Property name
-   `tag` **[String][49]?** Element tag

Returns **[String][49]** 

### headers_decode

Prepares headers to be sent to the client from a server

#### Parameters

-   `value`  
-   `data`   (optional, default `{}`)
-   `null-null` **[Object][47]** Headers

Returns **[Object][47]** 

### headers_encode

Prepares headers to be sent to the server from a client, calls URL handler so data object is needed

#### Parameters

-   `value`  
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.base` **[Object][47]?** Base URL, default is decoded version of the origin
    -   `data.route` **[Object][47]?** Adds to the query params if the result should be handled by the rewriter
    -   `data.type` **[Object][47]?** The type of URL this is (eg js, css, html), helps the rewriter determine how to handle the response
    -   `data.ws` **[Object][47]?** If the URL is a WebSocket
-   `null-null` **[Object][47]** Headers

Returns **[Object][47]** 

### cookie_encode

Prepares cookies to be sent to the client from a server, calls URL handler so

#### Parameters

-   `value` **[String][49]** Cookie header
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.url` **[Object][47]** Base URL (needed for hostname when adding suffix)

Returns **[Object][47]** 

### cookie_decode

Prepares cookies to be sent to the server from a client, calls URL handler so

#### Parameters

-   `value` **[String][49]** Cookie header
-   `data` **[Object][47]** Standard object for all rewriter handlers (optional, default `{}`)
    -   `data.origin` **[Object][47]** The page location or URL (eg localhost)
    -   `data.url` **[Object][47]** Base URL (needed for hostname when adding suffix)

Returns **[Object][47]** 

### decode_params

Decode params of URL, takes the prefix and then decodes a querystring

#### Parameters

-   `url`  
-   `URL` **([URL][50] \| [String][49])** to parse

Returns **URLSearchParams** 

### decompress

Decompresses response data

#### Parameters

-   `req`  
-   `res`  
-   `callback`  
-   `Client` **[Object][47]** request
-   `Request` **[Object][47]** response
-   `Callback` **[Function][54]** 

### valid_url

Validates a URL

#### Parameters

-   `args` **...any** 
-   `URL` **([URL][50] \| [String][49])** to parse
-   `Base` **([URL][50] \| [String][49])?** 

Returns **([Undefined][55] \| [URL][50])** Result, is undefined if an error occured

### str_conf

Returns a string version of the config\`

Returns **[Object][47]** 

### globals

Globals, called in the client to set any global data or get the proper fills object

#### Parameters

-   `url`  
-   `rw`  
-   `Local` **[URL][50]** URL incase the global object is not set
-   `Rewriter` **[Object][47]** instance

Returns **[Object][47]** Fills

### html_serial

Serializes a JSDOM or DOMParser object

#### Parameters

-   `dom`  
-   `DOM` **[Document][56]** 

Returns **[String][49]** 

### wrap

Wraps a string

#### Parameters

-   `str`  
-   `String`  

Returns **[String][49]** 

### checksum

Runs a checksum on a string

#### Parameters

-   `r`  
-   `e`   (optional, default `5381`)
-   `t`   (optional, default `r.length`)
-   `String`  

Returns **[Number][57]** 

[1]: #index

[2]: #parameters

[3]: #properties

[4]: #url

[5]: #parameters-1

[6]: #unurl

[7]: #parameters-2

[8]: #js

[9]: #parameters-3

[10]: #css

[11]: #parameters-4

[12]: #manifest

[13]: #parameters-5

[14]: #html

[15]: #parameters-6

[16]: #html_attr

[17]: #parameters-7

[18]: #plain

[19]: #parameters-8

[20]: #decode_blob

[21]: #parameters-9

[22]: #attr_type

[23]: #parameters-10

[24]: #headers_decode

[25]: #parameters-11

[26]: #headers_encode

[27]: #parameters-12

[28]: #cookie_encode

[29]: #parameters-13

[30]: #cookie_decode

[31]: #parameters-14

[32]: #decode_params

[33]: #parameters-15

[34]: #decompress

[35]: #parameters-16

[36]: #valid_url

[37]: #parameters-17

[38]: #str_conf

[39]: #globals

[40]: #parameters-18

[41]: #html_serial

[42]: #parameters-19

[43]: #wrap

[44]: #parameters-20

[45]: #checksum

[46]: #parameters-21

[47]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[48]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[49]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[50]: https://developer.mozilla.org/docs/Web/API/URL/URL

[51]: https://developer.mozilla.org/Add-ons/SDK/High-Level_APIs/request

[52]: https://developer.mozilla.org/docs/Web/API/Node/nextSibling

[53]: https://nodejs.org/api/buffer.html

[54]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[55]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/undefined

[56]: https://developer.mozilla.org/docs/Web/API/Document

[57]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number


## How it works:

Recieve request => parse URL => send request to server => rewrite content => send to client

### JS:

To achieve accuracy when rewriting, this proxy uses "scoping". All js is wrapped in a [closure](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures) to override variables that otherwise are not possible normally (window, document)

[Proxies](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy) are used to change or extend any value to be in line with rewriting URLs

Any occurance of `this` is changed to call the global rw_this function with the `this` value, if the `this` value has a property indicating that the value has a proxied version, return the proxied version.

An example:

Call the rewriter and parse:
```
if(window.location == this.location)alert('Everything checks out!');
```

Expected result:

```
{let fills=<bundled code>,window=fills.this,document=fills.document;if(window.location == rw_this(this).location)alert('Everything checks out!');
//# sourceURL=anonymous:1
}
```

`this` in the input code is defined as `window`, the `window` has a proxied version that will also determine if any properties are proxied and give a result.

`this` => `fills.this`

`this.location` => `fills.url`

#### HTML rewriting:

A part of getting down full HTML rewriting is also making sure any dynamically made elements are rewritten.

[Getters](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get) and [setters](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/set) are used for properties on the `Node.prototype` object for such as but not limited to:

- `outerHTML`
- `innerHTML`
- `getAttribute`
- `setAttribute`
- `setAttributeNS`
- `insertAdjacentHTML`
- `nonce`
- `integrity`
+ every attribute that is rewritten in the HTML side of things

Any property/function that inserts raw html code that is not rewritten is ran through the rewriters HTML handler.
Properties are handled by the rewriters HTML property handler (for consistency)

### CSS:

A basic regex to locate all `url()` blocks is used and the rewriters URL handler is called with the value and meta for the page

### HTML:

A bundled version of [JSDOM](https://www.npmjs.com/package/jsdom) is used to achieve accuracy and consistency when rewriting and [DOMParser](https://developer.mozilla.org/en-US/docs/Web/API/DOMParser) in the browser.

Each property is iterated and in the rewriter a huge array containing information for determining the type of attribute being worked with is used ( this includes tag and name).

- If the type is a URL then the resulting value is determined by the rewriters URL handler
- If the type is JS then the resulting value is determined by the rewriters JS handler along with being wrapped for encoding
- If the type is CSS then the resulting value is determined by the rewriters CSS handler along

### Manifest:

A basic JSON.stringify checking if the key is `src` or `key` or `start_url` and if it is then the rewriters URL handler is used to determine the result.
